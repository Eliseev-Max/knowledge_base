ERROR: failed to solve: ubuntu:20.04: failed to do request: Head "https://registry-1.docker.io/v2/library/ubuntu/manifests/20.04": tls: failed to verify certificate: x509: certificate signed by unknown authority

Error response from daemon: Get "https://registry-1.docker.io/v2/": tls: failed to verify certificate: x509: certificate signed by unknown authority

## https://kl1p.com/docker-pull-x509-certificate-signed-by-unknown-authority-with-code-examples/

При использовании Docker часто возникает необходимость извлекать образы из реестра, например DockerHub или частного реестра (private registry).
Однако при попытке извлечь образ из реестра, в котором используется сертификат x509, подписанный неизвестным источником,
вы можете столкнуться с сообщением об ошибке.

Эта ошибка возникает потому, что Docker не может проверить подлинность сертификата x509, предоставленного реестром.
Другими словами, Docker не доверяет центру сертификации (ЦС), подписавшему сертификат.
В следующей статье на примерах кода объясняется, как устранить эту проблему.

######################################
# Общие сведения о сертификатах x509 #
######################################

  Сертификат x509 - это цифровой сертификат, использующий стандарт x509.
  Обычно он используется для безопасной связи через интернет.
  Сертификаты x509 выдаются центром сертификации (ЦС) определенному владельцу, которым может быть организация, сервер или частное лицо.

  Сертификат x509 содержит следующую информацию:
    • идентификационные данные владельца (общее имя, название организации и т. д.)
    • идентификационные данные эмитента (имя центра сертификации, адрес электронной почты и т. д.)
    • серийный номер сертификата
    • Срок действия сертификата (даты начала и окончания)
    • Открытый ключ, связанный с владельцем сертификата
    • Подпись центра сертификации, выпустившего сертификат

  Подпись центра сертификации используется для проверки подлинности сертификата.
  Если ЦС пользуется доверием системы, получившей сертификат, то сертификат считается действительным.
  Однако если ЦС не доверяет, сертификат считается недоверенным.

Устранение проблем с сертификатами x509 в Docker

При извлечении образа из реестра, в котором используется сертификат x509, подписанный неизвестным центром,
вы получите сообщение об ошибке, которое выглядит примерно так:
---
$ docker pull registry.example.com/myimage
Using default tag: latest
Error response from daemon: Get https://registry.example.com/v2/: x509: certificate signed by unknown authority
---

Сообщение об ошибке указывает на то, что Docker не может проверить подлинность сертификата x509, предоставленного реестром.
Вот несколько шагов по устранению неполадок, чтобы решить проблему:

  1. Проверьте центр сертификации

    Первым делом необходимо проверить центр сертификации, выпустивший сертификат x509.
    Это можно сделать, выполнив следующую команду:

---
$ openssl s_client -connect registry.example.com:443 -showcerts
# openssl s_client -connect hub.docker.com:443 -showcerts
---

  Эта команда отобразит цепочку сертификатов для registry.example.com (hub.docker.com),
  включая корневой центр сертификации, подписавший сертификат.

  Найдите в выводе следующую строку:
---
Certificate chain
 0 s:/CN=registry.example.com
   i:/C=US/O=Unknown/OU=Unknown/CN=Unknown
---

  → Эта строка показывает, что сертификат был выпущен неизвестным ЦС.
  В этом случае вам может потребоваться получить корневой сертификат ЦС и добавить его в список доверенных корневых ЦС Docker.

  2. Добавление корневого ЦС в Docker

‼ Чтобы добавить корневой ЦС в Docker, выполните следующие действия:

  Шаг 1: Получите сертификат корневого ЦС.
    Вам нужно получить сертификат корневого ЦС, которым подписан сертификат x509, предоставленный реестром.
    Обычно это можно сделать, связавшись с администратором реестра и запросив сертификат.

  Шаг 2: Скопируйте сертификат в каталог доверенного корневого ЦС.
    Скопируйте сертификат в каталог /etc/docker/certs.d/registry.example.com/ на системе, где запущен Docker.
    Сертификат должен иметь имя ca.crt.

  Шаг 3: Перезапустите Docker
    Перезапустите демон Docker, чтобы убедиться, что новый сертификат загружен:
---
$ sudo systemctl restart docker
---

Проверка сертификата

Чтобы убедиться, что сертификат был добавлен правильно, выполните следующую команду:
---
$ openssl s_client -connect registry.example.com:443 -showcerts
---
В цепочке сертификатов должен появиться сертификат корневого центра сертификации:
---
Certificate chain
 0 s:/CN=registry.example.com
   i:/C=US/O=My CA/OU=My Unit

 1 s:/C=US/O=My CA/OU=My Unit
   i:/C=US/O=My CA/OU=My Unit
---

  4. Извлеките образ

После добавления сертификата корневого ЦС вы должны иметь возможность извлечь образ из реестра:
---
$ docker pull registry.example.com/myimage
---

Заключение

В этой статье мы рассмотрели, как устранять проблемы с сертификатами x509 в Docker.
Если вы столкнулись с сообщением об ошибке при извлечении образа из реестра, в котором используется сертификат x509,
подписанный неизвестным центром, вам нужно добавить сертификат корневого центра сертификации в список доверенных корневых центров сертификации Docker.
Это позволит Docker проверить подлинность сертификата и извлечь образ из реестра.

Сертификаты x509 являются важным инструментом для обеспечения безопасности онлайн-коммуникаций, предоставляя криптографическую защиту и механизмы аутентификации для безопасного обмена данными. Docker имеет встроенную поддержку HTTPS, а это значит, что он может использовать сертификаты x509 для безопасного взаимодействия с реестрами.

Когда Docker извлекает образ из реестра, он проверяет цепочку сертификатов, чтобы убедиться, что сертификат, представленный реестром, был подписан доверенным центром сертификации. Если сертификат, представленный реестром, был подписан неизвестным центром или тем, которому не доверяет хост Docker, он выдаст сообщение об ошибке.

Устранение проблем с сертификатами x509 в Docker

Первым шагом в устранении проблемы с сертификатом x509 в Docker является определение первопричины проблемы. Для этого можно изучить цепочку сертификатов для удаленного хранилища и убедиться, что на вашем хосте есть необходимые сертификаты.
Убедившись, что они установлены правильно, можно попробовать выполнить следующие действия:
Проверьте, распознан ли центр сертификации

Если Docker не может проверить подлинность сертификата, представленного реестром, это может быть связано с недоверенным центром сертификации. Вы можете вручную доверить центр сертификации, подписавший сертификат удаленного хранилища, добавив его открытый ключ в файл /etc/docker/certs.d/registry_hostname_or_ip/ca.crt на хосте клиента Docker.

Загрузите сертификат, представленный реестром

Если реестр выдает ошибку при попытке извлечь образ, контейнерный движок предоставляет возможность загрузить все файлы, которые вызывают ошибку. Следующая команда загрузит сертификат, представленный реестром, в файл repository.crt
---
$ openssl s_client -showcerts -connect hostname:port </dev/null | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' > ~/repository.crt
---

Добавьте сертификат корневого центра сертификации в хранилище доверенных центров сертификации хоста

Если вы получили сертификат из безопасного реестра, который ранее не был установлен на хосте, вам нужно добавить его в хранилище доверенных центров сертификации хоста. Сначала нужно найти корневой сертификат ЦС для центра выдачи сертификатов, а затем добавить этот сертификат в каталог /etc/pki/ca-trust/source/anchors/. Наконец, обновите список доверенных ЦС системы с помощью следующей команды:

sudo update-ca-trust

Заключение

Docker - это чрезвычайно мощный и гибкий инструмент виртуализации контейнеров, который предлагает отличную поддержку безопасного сетевого взаимодействия, включая сертификаты x509. Хотя система может выдавать ошибки, связанные с этими сертификатами, обычно это связано с неправильной конфигурацией на сервере или отсутствием сертификата на клиенте.
Следуя шагам, описанным в этой статье, вы сможете диагностировать и решить эти проблемы и обеспечить безопасную работу Docker.