Настройка обратного прокси (Reverse proxy configuration)

{ https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-with-jenkins/ }

[!] "Reverse proxy - Issues": https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-troubleshooting/
#(ОЗНАКОМИТЬСЯ)

Обратный прокси позволяет альтернативному провайдеру HTTP || HTTPS взаимодействовать с веб-браузерами от имени Jenkins.
Альтернативный провайдер может предоставлять дополнительные возможности, например, шифрование SSL.
Альтернативный провайдер может разгрузить Jenkins от некоторой работы,
(например, от доставки статических изображений).

Общие рекомендации

Jenkins активно отслеживает конфигурацию обратного прокси.
Проблема с конфигурацией обратного прокси → Jenkins: "Your reverse proxy setup is broken"
‼ Eсли Jenkins сообщает, что ваша настройка обратного прокси нарушена:
	см. раздел "Устранение неполадок"
	(https://www.jenkins.io/doc/book/system-administration/reverse-proxy-configuration-troubleshooting/)

Справочная информация

[Внешний запросчик] >-(HTTP-запрос)→ {Обратный proxy-сервер: переписывает запрос} → [Jenkins]

Обратный прокси-сервер:
1. Запрос к Jenkins:
	1.1 получает входящие HTTP-запросы;
	1.2 (переписывает HTTP-запрос) - как правило;
	1.3 направляет запрос в Jenkins;
2. Исходящий от Jenkins ответ
	2.1 получает исходящий HTTP-ответ;
	2.2 (переписывает HTTP-ответ) - как правило;
	2.3 направляет эти запросы первоначальному запросчику

‼ Если переписывание HTTP-запросов настроено неправильно, страницы вообще не будут отображаться.
  Обратитесь к примерам конфигурации, если ваш обратный прокси не отображает страницы Jenkins.

Обратный прокси должен обрабатывать HTTP ответ
	► либо переписывая его;
	► либо устанавливая HTTP заголовки для перенаправленного запроса.

Если обработка HTTP-ответов настроена неправильно:
	Jenkins может не отображать обновленную информацию на странице
		или
	игнорировать изменения, отправленные через веб-страницы.
‼ Если
	• Jenkins сообщает, что ваша настройка обратного прокси нарушена;
	• страницы ведут себя не так, как ожидалось,
→ см. раздел "Устранение неполадок"

---
{ Reverse proxy
	https://en.wikipedia.org/wiki/Reverse_proxy
}

В компьютерных сетях обратный прокси - это приложение, которое находится перед внутренними приложениями и перенаправляет запросы клиента (например, браузера) к этим приложениям.
Обратные прокси помогают повысить
	• масштабируемость,
	• производительность,
	• отказоустойчивость
	• безопасность

Ресурсы, возвращаемые клиенту, выглядят так, как будто они исходят от самого веб-сервера.

Крупные веб-сайты и сети доставки контента используют обратные прокси, наряду с другими методами, для балансировки нагрузки между внутренними серверами. 
Обратные прокси могут хранить кэш статического контента, что еще больше снижает нагрузку на эти внутренние серверы и внутреннюю сеть.
Также часто обратные прокси добавляют такие функции, как сжатие или шифрование TLS в канал связи:
  Клиент <--> обратный прокси.

Обратные прокси обычно принадлежат веб-сервису или управляются им,
и клиенты получают к ним доступ из публичного Интернета.

# В отличие от этого, прямой прокси-сервер обычно управляется клиентом (или его компанией),
  который ограничен частной внутренней сетью,
  за исключением того, что клиент может попросить прямой прокси-сервер получить ресурсы из публичного Интернета от имени клиента.

Обратные прокси-серверы реализованы в популярных веб-серверах с открытым исходным кодом
  • Apache,
  • Nginx,
  • Caddy
  • Squid и т.д.
	
Это программное обеспечение может проверять HTTP-заголовки;
  -> это позволяет ему представлять один IP-адрес в Интернете,
     а запросы направлять на различные внутренние серверы, основываясь на доменном имени HTTP-запроса.

Специальные обратные прокси-серверы, такие как программное обеспечение с открытым исходным кодом
  * HAProxy
    и
  * Squid,
  используются некоторыми из крупнейших веб-сайтов в Интернете. 

Использование

Обратные прокси-серверы могут скрывать существование и характеристики исходных серверов.
Функции брандмауэра приложений могут защитить от распространенных веб-атак, таких как
  > атака на отказ в обслуживании (DoS)
  > или распределенная атака на отказ в обслуживании (DDoS).

  Без обратного прокси удаление вредоносного ПО или, например, инициирование захвата может быть затруднено.
В случае защищенных веб-сайтов веб-сервер может не выполнять шифрование TLS самостоятельно, а переложить эту задачу на обратный прокси-сервер, который может быть оснащен аппаратным ускорителем TLS. (См. раздел "Оконечный прокси-сервер TLS").
Обратный(е) прокси-сервер(ы) может|могут:
  ✓ распределять нагрузку от входящих запросов на несколько серверов, причем каждый сервер поддерживает свою область приложений.
    В случае обратного проксирования веб-серверов, обратный прокси может быть вынужден переписывать URL в каждом входящем запросе,
    чтобы соответствовать внутреннему расположению запрашиваемого ресурса.

  ✓ снизить нагрузку на свои исходные серверы за счет кэширования статического и динамического содержимого, известного как веб-ускорение.
    Подобные прокси-кэши часто могут удовлетворять значительное количество запросов к веб-сайтам, значительно снижая нагрузку на серверы происхождения.

  ✓ оптимизировать контент, сжимая его, чтобы ускорить время загрузки.
    В технике, называемой "кормление с ложечки",[3] динамически генерируемая страница может быть создана вся сразу и передана обратному прокси-серверу, который затем может вернуть ее клиенту понемногу за раз. Программа, генерирующая страницу, не должна оставаться открытой, что позволяет освободить ресурсы сервера на время, которое может потребоваться клиенту для завершения передачи данных.

  ✓ использоваться там, где несколько веб-серверов должны быть доступны через один публичный IP-адрес.
    Веб-серверы прослушивают разные порты на одной машине, с одним и тем же локальным IP-адресом или, возможно, на разных машинах с разными локальными IP-адресами. Обратный прокси анализирует каждый входящий запрос и доставляет его на нужный сервер в локальной сети.

  ✓ выполнять A/B тестирование и многомерное тестирование без размещения тегов JavaScript или кода на страницах.

  ✓ добавить аутентификацию доступа к веб-серверу, который не имеет аутентификации.

Риски

Обратный прокси-сервер может отслеживать все IP-адреса, делающие через него запросы, а также читать и изменять любой незашифрованный трафик. Таким образом, он может регистрировать пароли или внедрять вредоносные программы, и может делать это, если скомпрометирован или запущен вредоносной стороной.
    Когда транзитный трафик зашифрован, а обратному прокси необходимо фильтровать/кэшировать/сжимать или иным образом изменять или улучшать трафик, прокси сначала должен расшифровать и заново зашифровать соединения. Это требует от прокси обладания сертификатом TLS и соответствующим закрытым ключом, что расширяет количество систем, которые могут иметь доступ к незашифрованным данным, и делает их более ценной целью для злоумышленников.
    Подавляющее большинство внешних утечек данных происходит либо когда хакерам удается использовать существующий обратный прокси-сервер, который был намеренно развернут организацией, либо когда хакерам удается преобразовать существующий сервер, выходящий в Интернет, в обратный прокси-сервер. Взломанные или преобразованные системы позволяют внешним злоумышленникам указывать, куда они хотят направлять свои атаки, открывая доступ к внутренним сетям и системам.
    Приложения, разработанные для внутреннего пользования компании, как правило, не укреплены в соответствии с общественными стандартами и не обязательно предназначены для противостояния всем попыткам взлома. Когда организация разрешает внешний доступ к таким внутренним приложениям через обратный прокси, она может непреднамеренно увеличить свою собственную поверхность атаки и пригласить хакеров.
    Если обратный прокси-сервер не настроен на фильтрацию атак или не получает ежедневных обновлений для поддержания актуальности базы данных сигнатур атак, уязвимость нулевого дня может пройти без фильтрации, позволяя злоумышленникам получить контроль над системой (системами), которая находится за обратным прокси-сервером.
    Использование обратного прокси третьей стороны (например, Cloudflare, Imperva) передает всю триаду конфиденциальности, целостности и доступности в руки третьей стороны, управляющей прокси.
    Если обратный прокси обслуживает множество различных доменов, его отключение (например, из-за неправильной конфигурации или DDoS-атаки) может вывести из строя все домены, обслуживающие обратный прокси[6].
    Обратные прокси также могут стать единой точкой отказа, если нет другого способа получить доступ к обратному серверу.
